<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Tourist - Travel Agency HTML Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">

  <script src="customNavbar.js" type="text/javascript" defer></script>
  <script src="customFooter.js" type="text/javascript" defer></script>
  <script src="firebase.js"  type="text/javascript" defer></script>

</head>

<body>
    <!-- Spinner Start -->
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->


  <!-- Navbar Start -->
    <navbar-component></navbar-component>
  <!-- Navbar  Hero End -->


    <!-- Process Start -->
    <div class="container-xxl py-5">
        <div class="container">
            <div class="text-center pb-4 wow fadeInUp" data-wow-delay="0.1s">
                <h6 class="section-title bg-white text-center text-primary px-3">Process</h6>
                <h1 class="mb-5">3 Easy Steps</h1>
            </div>
            <div class="row gy-5 gx-4 justify-content-center">
                <div class="col-lg-4 col-sm-6 text-center pt-4 wow fadeInUp" data-wow-delay="0.1s">
                    <div class="position-relative border border-primary pt-5 pb-4 px-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-primary rounded-circle position-absolute top-0 start-50 translate-middle shadow" style="width: 100px; height: 100px;">
                            <i class="fa fa-hotel fa-3x text-white"></i>
                        </div>
                        <h5 class="mt-4">Choose A Hostel</h5>
                        <hr class="w-25 mx-auto bg-primary mb-1">
                        <hr class="w-50 mx-auto bg-primary mt-0">
                        <p class="mb-0">Choose a hostel according to your level</p>
                    </div>
                </div>
                <div class="col-lg-4 col-sm-6 text-center pt-4 wow fadeInUp" data-wow-delay="0.3s">
                    <div class="position-relative border border-primary pt-5 pb-4 px-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-primary rounded-circle position-absolute top-0 start-50 translate-middle shadow" style="width: 100px; height: 100px;">
                            <i class="fa fa-bed fa-3x text-white"></i>
                        </div>
                        <h5 class="mt-4">Choose A Room</h5>
                        <hr class="w-25 mx-auto bg-primary mb-1">
                        <hr class="w-50 mx-auto bg-primary mt-0">
                        <p class="mb-0">Choose A Room Inside The Hostel You Picked Earlier</p>
                    </div>
                </div>
                <div class="col-lg-4 col-sm-6 text-center pt-4 wow fadeInUp" data-wow-delay="0.5s">
                    <div class="position-relative border border-primary pt-5 pb-4 px-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-primary rounded-circle position-absolute top-0 start-50 translate-middle shadow" style="width: 100px; height: 100px;">
                            <i class="fa fa-users fa-3x text-white"></i>
                        </div>
                        <h5 class="mt-4">Pick Your Roomates</h5>
                        <hr class="w-25 mx-auto bg-primary mb-1">
                        <hr class="w-50 mx-auto bg-primary mt-0">
                        <p class="mb-0">Invite people into your room via a code or allow the system to pick your roommates at random</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Process Start -->


    <!-- Booking Start -->
    <div class="container-xxl py-5 wow fadeInUp" data-wow-delay="0.1s">
        <div class="container">
            <div class="booking p-5">
                <div class="row g-5 align-items-center ">
                    <div class="col-md-6 text-white">
                        <h6 class="text-white text-uppercase">Booking</h6>
                        <h1 class="text-white mb-4">Online Booking</h1>
                        <p class="mb-4">Book a room that is suitable for you</p>
                  
                    </div>
                    <div class="col-md-6">
                        <h1 class="text-white mb-4">Book A Room</h1>
                        <form>
                            <div class="row g-3">
                              
                               
                                <div class="col-md-6">
                                <div class="form-floating">
                                        <select class="form-select bg-white-50 text-dark" id="gender">
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                       
                                        </select>
                                        <label for="gender">Gender</label>
                                    </div>
                          
                                </div>
								 <div class="col-md-6">
                                <div class="form-floating">
                                        <select class="form-select bg-white-50 text-dark" id="plan">
                                            <option value="Room Of 3">Room Of 3</option>
                                            <option value="Room Of 4">Room Of 4</option>
                                            <option value="Room Of 6">Room Of 6</option>
                                       
                                        </select>
                                        <label for="plan">Plan Name</label>
                                    </div>
                          
                                </div>
                                <div class="col-md-6">
                                <div class="form-floating">
                                        <select class="form-select bg-white-50 text-dark" id="hostel">
                                            <option value="zambezi">Zambezi: 300-500 lvl</option>
                                          <option value="blue-nile">Blue Nile: 100-200 lvl</option>
                                          <option value="orange-nile">Orange Nile: 200-300 lvl</option>
                                          <option value="congo">Congo House: 100 lvl</option>
                          

                                        </select>
                                        <label for="hostel">Hostel</label>
                                    </div>

                                </div>
								
                              <div class="col-md-6">
                              <div class="form-floating">
                                      <select class="form-select bg-white-50 text-dark" id="floor">
                                          <option value="ground-floor">Ground Floor</option>
                                        <option value="first-floor">First Floor</option>
                                        <option value="second-floor">Second Floor</option>
                                        <option value="third-floor" >Third Floor</option>
                                    

                                      </select>
                                      <label for="floor">Preferred Floor</label>
                                  </div>

                              </div>

<div class="col-md-6">
                              <div class="form-floating">
                                      <select class="form-select bg-white-50 text-dark" id="invite">
                                          <option value="invite-yes">Yes</option>
                                        <option value="invite-no">No</option>

                                    

                                      </select>
                                      <label for="floor">Book With Friends?</label>
                                  </div>

                              </div>
							  <div class="col-md-6">
                              <div class="form-floating">
                                      <select class="form-select bg-white-50 text-dark" id="meal">
                                          <option value="meal-yes">Yes</option>
                                        <option value="meal-no">No</option>

                                    

                                      </select>
                                      <label for="meal">Meal Included?</label>
                                  </div>

                              </div>

							  
							  <div class="col-md-6">
                              <div class="form-floating">
                                      <select class="form-select bg-white-50 text-dark" id="room">
                                      

                                      </select>
                                      <label for="room">Preferred Room</label>
                                  </div>

                              </div>

                              
                                <div class="col-12">
                                    <a class="btn btn-outline-light w-100 py-3"  id="reserve" >Book Now</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Booking Start -->
        

  <!-- Footer Start -->
  <footer-component></footer-component>
  <!-- Footer End -->


    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
	<script type="module">
    //Update the below URL with the appropriate version if necessary.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-app.js";
    import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      updateProfile 
    //Update the below URL with the appropriate version if necessary.
    } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-auth.js";
	   import {
        getFirestore,
        setDoc,
        doc,
        addDoc,
		getDocs,
		query,
		collection,
		where
      } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-firestore.js";


    // INSERT YOUR FIREBASE CONFIG OBJECT HERE
    const firebaseConfig = {

      apiKey: "AIzaSyAnAt57T3pVCU-Rw1GRw4tivhvBcC_NmzM",

      authDomain: "dormpro-3f0e3.firebaseapp.com",

      databaseURL: "https://dormpro-3f0e3-default-rtdb.firebaseio.com",

      projectId: "dormpro-3f0e3",

      storageBucket: "dormpro-3f0e3.appspot.com",

      messagingSenderId: "688445848812",

      appId: "1:688445848812:web:9fba956b87f59bf756f9c9",

      measurementId: "G-119MDWZXMR"

    };

      const reserveButton = document.querySelector("#reserve");


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
	const db = getFirestore(app);
	
	async function updateRoomOptions() {
    var floorSelect = document.getElementById("floor");
    var roomSelect = document.getElementById("room");
    var hostelSelect = document.getElementById("hostel");
    var floorValue = floorSelect.value;

    // Clear existing room options
    roomSelect.innerHTML = "";


    // Generate room options based on the selected floor
    var startRoom, endRoom;
    switch (floorValue) {
        case "ground-floor":
            startRoom = 1;
            endRoom = 20;
            break;
        case "first-floor":
            startRoom = 101;
            endRoom = 120;
            break;
        case "second-floor":
            startRoom = 201;
            endRoom = 220;
            break;
        case "third-floor":
            startRoom = 301;
            endRoom = 320;
            break;
        default:
            // Default to ground floor if floorValue is not recognized
            startRoom = 1;
            endRoom = 20;
            break;
    }

    var option = document.createElement("option");
    option.value = "";
    option.textContent = "";
    roomSelect.appendChild(option);


    // Generate room options based on the selected floor, excluding booked rooms
    for (var roomNum = startRoom; roomNum <= endRoom; roomNum++) {
        // Check if the room is booked and meets the specified criteria
        
        // Add the room option only if it's not booked
            var option = document.createElement("option");
            option.value = roomNum.toString().padStart(3, "0");
            option.textContent = roomNum.toString().padStart(3, "0"); // Pad room number with leading zeros
            roomSelect.appendChild(option);
     
    }
}


	
	// Add event listener to floor select to update room options
    var floorSelect = document.getElementById("floor");
    floorSelect.addEventListener("change", updateRoomOptions);

    // Initialize room options based on the default floor selection
    updateRoomOptions();
	
	
	// Function to dynamically update hostel options based on selected gender
function updateHostelOptions() {
    const genderSelect = document.getElementById('gender');
    const hostelSelect = document.getElementById('hostel');
    const selectedGender = genderSelect.value;

    // Clear previous options
    hostelSelect.innerHTML = '';
	


    // Define default options based on selected gender
    const defaultOptions = {
        male: [
            { value: '', text: '' },
            { value: 'zambezi', text: 'Zambezi: 300-500 lvl' },
            { value: 'blue-nile', text: 'Blue Nile: 100-200 lvl' },
            { value: 'orange-nile', text: 'Orange Nile: 200-300 lvl' },
            { value: 'congo', text: 'Congo House: 100 lvl' }
        ],
        female: [
            { value: '', text: '' },
            { value: 'white-nile', text: 'White Nile: 100-300 lvl' },
            { value: 'nile-delta', text: 'Nile Delta: 100 lvl' },
            { value: 'shebelle', text: 'Shebelle: 100-300 lvl' },
            { value: 'missisipi', text: 'Missisipi: 300, 400 & 500 Level' }
        ]
    };

    // Add default options to select element
    defaultOptions[selectedGender].forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        hostelSelect.appendChild(optionElement);
    });

    // Update hostel select value based on selected gender
    hostelSelect.value = defaultOptions[selectedGender][0].value;
}
// Run updateHostelOptions whenever gender select changes
document.getElementById('gender').addEventListener('change', updateHostelOptions);
updateHostelOptions(); // Run initially with default gender options

	
	// Declare global variables to store input and select values
let selectedValues = {};

// Function to get selected value from a select element by element id
function getSelectedValue(elementId) {
  var element = document.getElementById(elementId);
  selectedValues[elementId] = element.value; // Update global selectedValues object
  return element.value;
}

// Function to update selected value from a select element
function updateSelectedValue(element) {
  selectedValues[element.id] = element.value; // Update global selectedValues object
  return element.value;
}


// Run getSelectedValue and getInputValue on page load
document.addEventListener('DOMContentLoaded', function() {
  // Get selected value of select elements
  document.querySelectorAll('select').forEach(select => {
    selectedValues[select.id] = select.value; // Update global selectedValues object
  });
});

// Add event listeners to all select elements to update selected value on change
document.querySelectorAll('select').forEach(select => {
  select.addEventListener('change', function() {
    updateSelectedValue(select);
    console.log(`Selected values:`, selectedValues);
  });
});

async function fetchReservation(collectionRef) {
		let keys = []

    try {
        const querySnapshot = await getDocs(collectionRef);

        querySnapshot.forEach((doc) => {
            keys.push(doc.id);
        });
		return keys;
    } catch (error) {
        console.error("Error getting documents: ", error);
    }

    console.log("Keys outside fetchData:", keys);
}


async function roomsTaken() {
		let keys = []
const collectionRef = collection(db, "hostel_reservation");

    try {
        const querySnapshot = await getDocs(collectionRef);

        querySnapshot.forEach((doc) => {
			let hostel = doc.data().hostel;
			let room = doc.data().room;
			let approved = doc.data().approved;
			let invite = doc.data().invite;
			let room_capacity = doc.data().room_capacity;
			
			let roomInfo = {
				hostel,
				room,
				approved,
				invite,
				room_capacity
			}
            keys.push(roomInfo);
        });
		return keys;
    } catch (error) {
        console.error("Error getting documents: ", error);
    }

    console.log("Keys outside fetchData:", keys);
}


	const isAnyStringValueEmpty = obj => Object.values(obj).some(value => typeof value === 'string' && value.trim() === '');



function getTotalPeopleInRoom(rooms, room, hostel) {
  return rooms.reduce((count, roomData) => {
    // Include rooms with matching room and hostel, regardless of no_members value
    return count + (roomData.room === room && roomData.approved == "yes" && roomData.hostel === hostel ? 1 : 0);
  }, 0);
}

	    const bookReservation = async () => {
		       let email = auth.currentUser?.email;

console.log(email)

		console.log(selectedValues)
		const currentDate = new Date();
const year = currentDate.getFullYear();
const month = currentDate.getMonth() + 1; // Month is zero-indexed, so we add 1
const day = currentDate.getDate();

const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

            const reserveID = email + "-" + selectedValues.hostel+ "-" + formattedDate;

const collectionRef = collection(db, "hostel_reservation");

    let keys = await fetchReservation(collectionRef);
	const filteredKeys = keys.filter(key => key.includes(email));

    console.log("Keys:", keys);
// Check if the conditions are met for any booked room

	const bookedRooms = await roomsTaken();

let isRoomBooked = false;
isRoomBooked = bookedRooms.some(room => {
    return (
        room.hostel === selectedValues.hostel &&
        room.invite === "yes" &&
        room.room === selectedValues.room&&
		room.approved === "yes"
    );
});

let bookedRoom = bookedRooms.filter(room => room.room == selectedValues.room) || [];
console.log(isRoomBooked);
let noRoomMembers = getTotalPeopleInRoom(bookedRooms, selectedValues.room, selectedValues.hostel)
console.log(noRoomMembers)
console.log(bookedRoom.length)
let inviting = bookedRooms.some(room => room.room === selectedValues.room && room.hostel === selectedValues.hostel) ? "no" : selectedValues.invite.replace(/^invite-/, '');

const isRoomFull = (noRoomMembers, bookedRoom) => {
	if(!bookedRoom) return false;
  return (parseInt(noRoomMembers) === parseInt(bookedRoom.room_capacity)) && (parseInt(noRoomMembers) != 0);
};


	 if(isAnyStringValueEmpty(selectedValues)){
				alert("Please enter all inputs")

	}
		else if(isRoomBooked){
		alert("Room is already booked")
	
	}else if(isRoomFull()){
		
		alert("Sorry the room is full")
	}
	
	else if (filteredKeys.length > 0){
		alert("You have already made a reservation")
	}
	
	else{
	
	
		 // Concatenate strings using the + operator
            const reserveID = email + "-" + selectedValues.hostel+ "-" + formattedDate;
            // Set the document in the "ticket" collection

          await setDoc(doc(db, "hostel_reservation", reserveID), {
room_capacity: selectedValues.plan.match(/\d+/)[0],
              hostel: selectedValues.hostel,
              floor: selectedValues.floor,
              meal_plan: selectedValues.meal === "meal-yes" ? true : false,
			  room: selectedValues.room,
              user_id:email.replace(/\./g, "-dot-"),
			  approved: "waiting",
			  code:"",
			  invite: inviting,
			  no_members:String(noRoomMembers)
			  
            });
			alert("Hostel Request Sent")
        
	
	}
		
		
		}

	 reserveButton.addEventListener("click", bookReservation);

	const checkAuthState = async() => {
        onAuthStateChanged(auth, user => {
            if(user) {
					console.log(user.email);
        
            }
            else {
              			window.location.href = '/register';

            }
        })
    }
 
     checkAuthState();

	</script>


    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
</body>

</html>